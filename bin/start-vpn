#!/bin/bash

VPNIPPOOL="10.15.1.0/24"

iptables -t nat -A POSTROUTING -s 10.15.1.0/24 -o eth0 -m policy --dir out --pol ipsec -j ACCEPT
iptables -t nat -A POSTROUTING -s 10.15.1.0/24 -o eth0 -j MASQUERADE

iptables -L

rm -f /var/run/starter.charon.pid

# Create certificate
cd /data/key_files
ipsec pki --gen --type rsa --size 4096 --outform pem > /data/key_files/private/ca-key.pem
ipsec pki --self --ca --lifetime 3650 --in /data/key_files/private/ca-key.pem --type rsa --dn "CN=VPN root CA" --outform pem > /data/key_files/cacerts/ca-cert.pem
ipsec pki --gen --type rsa --size 4096 --outform pem > /data/key_files/private/server-key.pem
ipsec pki --pub --in /data/key_files/private/server-key.pem --type rsa \
    | ipsec pki --issue --lifetime 1825 \
        --cacert /data/key_files/cacerts/ca-cert.pem \
        --cakey /data/key_files/private/ca-key.pem \
        --dn "CN=vpn.drzhn.in" --san "vpn.drzhn.in" \
        --flag serverAuth --flag ikeIntermediate --outform pem \
    > /data/key_files/certs/server-cert.pem

# Copy certificate to ipsec dir
cp -r /data/key_files/* /usr/local/etc/ipsec.d/

echo "${VPNHOST} : RSA \"server-key.pem\"
testuser : EAP \"testuser1\"
" > /usr/local/etc/ipsec.secrets

sysctl -p

ipsec start --nofork